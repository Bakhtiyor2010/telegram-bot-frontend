<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    h1, h2 {
      text-align: center;
      color: #333;
    }

    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    textarea {
      resize: vertical;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover {
      background-color: #f1f7ff;
    }

    a {
      text-decoration: none;
      color: #007bff;
    }

    .action-btn {
      background-color: #dc3545;
    }

    .action-btn:hover {
      background-color: #a71d2a;
    }

    .pagination {
      text-align: center;
      margin-top: 20px;
    }

    .pagination button {
      margin: 0 5px;
    }

    @media(max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead tr {
        display: none;
      }

      td {
        padding: 10px;
        text-align: right;
        position: relative;
        border: none;
        border-bottom: 1px solid #eee;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        text-align: left;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Panel - Users</h1>

    <h2>Send Message</h2>
    <textarea id="messageText" rows="3" placeholder="Enter your message..."></textarea>
    <button onclick="sendMessage()">Send Message</button>

    <h2>Search Users</h2>
    <input type="text" id="searchInput" placeholder="Search by name, surname or phone...">

    <table id="usersTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"> Select</th>
          <th>#</th>
          <th>Name</th>
          <th>Surname</th>
          <th>Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

<script>
let users = [];
let filteredUsers = [];
let currentPage = 1;
const rowsPerPage = 10;
let selectedUserIds = new Set();
const tableBody = document.querySelector("#usersTable tbody");
const paginationDiv = document.getElementById("pagination");
const searchInput = document.getElementById("searchInput");
const selectAllCheckbox = document.getElementById("selectAll");

// Event listeners
searchInput.addEventListener('input', handleSearch);
selectAllCheckbox.addEventListener('change', toggleSelectAll);

// 1. Load users
async function loadUsers() {
  try {
    const res = await fetch("https://successful-grace-production-5eea.up.railway.app/api/users");
    if (!res.ok) throw new Error("Error fetching users: " + res.status);
    users = await res.json();
    filteredUsers = [...users];
    currentPage = 1;
    renderTable();
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
}

// 2. Handle search
function handleSearch() {
  const searchText = searchInput.value.toLowerCase().trim();
  
  if (searchText === '') {
    filteredUsers = [...users];
  } else {
    filteredUsers = users.filter(u =>
      u.name.toLowerCase().includes(searchText) ||
      u.surname.toLowerCase().includes(searchText) ||
      u.phone.toLowerCase().includes(searchText)
    );
  }
  
  currentPage = 1;
  renderTable();
}

// 3. Render table
function renderTable() {
  tableBody.innerHTML = "";

  if (filteredUsers.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center; color: #555;">No users found</td>`;
    tableBody.appendChild(tr);
    paginationDiv.style.display = "none";
    updateSelectAllCheckbox();
    return;
  }

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginatedUsers = filteredUsers.slice(start, end);

  paginatedUsers.forEach((user, index) => {
    const tr = document.createElement("tr");
    const globalIndex = start + index + 1;
    const isChecked = selectedUserIds.has(user._id);
    
    tr.innerHTML = `
      <td data-label="Select">
        <input type="checkbox" class="userCheckbox" value="${user._id}" ${isChecked ? 'checked' : ''}>
      </td>
      <td data-label="#">${globalIndex}</td>
      <td data-label="Name">${user.name}</td>
      <td data-label="Surname">${user.surname}</td>
      <td data-label="Phone"><a href="tel:${user.phone}">${user.phone}</a></td>
      <td data-label="Actions">
        <button class="action-btn" onclick='deleteUser("${user._id}")'>Delete</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });

  // Add event listeners to checkboxes
  document.querySelectorAll('.userCheckbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      toggleUserSelection(this);
    });
  });

  renderPagination();
  updateSelectAllCheckbox();
}

// 4. Render pagination
function renderPagination() {
  const totalPages = Math.ceil(filteredUsers.length / rowsPerPage);
  paginationDiv.innerHTML = "";
  
  if (totalPages <= 1) {
    paginationDiv.style.display = "none";
    return;
  }
  
  paginationDiv.style.display = "block";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) {
      btn.style.fontWeight = "bold";
      btn.style.backgroundColor = "#0056b3";
    }
    btn.onclick = () => {
      currentPage = i;
      renderTable();
    };
    paginationDiv.appendChild(btn);
  }
}

// 5. Toggle user selection
function toggleUserSelection(checkbox) {
  const userId = checkbox.value;
  
  if (checkbox.checked) {
    selectedUserIds.add(userId);
  } else {
    selectedUserIds.delete(userId);
  }
  
  updateSelectAllCheckbox();
}

// 6. Update "Select All" checkbox state
function updateSelectAllCheckbox() {
  const checkboxes = document.querySelectorAll('.userCheckbox');
  
  if (checkboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    return;
  }
  
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  if (checkedCount === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCount === checkboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

// 7. Toggle select all
function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('.userCheckbox');
  const shouldCheck = selectAllCheckbox.checked;
  
  checkboxes.forEach(cb => {
    cb.checked = shouldCheck;
    const userId = cb.value;
    
    if (shouldCheck) {
      selectedUserIds.add(userId);
    } else {
      selectedUserIds.delete(userId);
    }
  });
  
  updateSelectAllCheckbox();
}

// 8. Delete user
async function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;
  
  try {
    const res = await fetch(`https://successful-grace-production-5eea.up.railway.app/api/users/${userId}`, { 
      method: "DELETE" 
    });
    
    if (!res.ok) {
      const errData = await res.json();
      alert("Error: " + (errData.error || res.status));
      return;
    }
    
    const data = await res.json();
    alert(data.message);
    selectedUserIds.delete(userId);
    await loadUsers();
  } catch (err) {
    console.error(err);
    alert("Failed to delete user!");
  }
}

// 9. Send message
async function sendMessage() {
  const message = document.getElementById("messageText").value.trim();
  
  if (!message) { 
    alert("Message cannot be empty!"); 
    return; 
  }
  
  if (selectedUserIds.size === 0) { 
    alert("Please select at least one user"); 
    return; 
  }

  try {
    const res = await fetch("https://successful-grace-production-5eea.up.railway.app/api/send-message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        userIds: Array.from(selectedUserIds), 
        message 
      })
    });

    if (!res.ok) {
      const errData = await res.json();
      alert("Error: " + (errData.error || res.status));
      return;
    }

    const data = await res.json();
    alert("Message was sent successfully!");
    document.getElementById("messageText").value = "";
    selectedUserIds.clear();
    selectAllCheckbox.checked = false;
    renderTable();
  } catch (err) {
    console.error(err);
    alert("Failed to send message!");
  }
}

// Initialize
loadUsers();
</script>

</body>
</html>